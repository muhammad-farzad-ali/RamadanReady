<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="RamadanReady - Manage your fasting calendars">
    <meta name="theme-color" content="#1e3a5f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ramadan">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    
    <title>RamadanReady</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    
    <!-- Styles -->
    <link rel="stylesheet" href="css/styles.css">
    <noscript>
        <div style="padding: 40px; text-align: center; font-family: sans-serif;">
            <h1>RamadanReady</h1>
            <p>JavaScript is required to run this app. Please enable JavaScript in your browser settings.</p>
        </div>
    </noscript>
</head>
<body>
    <!-- App Container -->
    <div id="app">
        <!-- Navigation -->
        <nav id="navbar">
            <div class="nav-brand">
                <h1>RamadanReady</h1>
            </div>
            <div class="nav-links">
                <button class="nav-btn active" data-screen="home">Home</button>
                <button class="nav-btn" data-screen="calendars">Calendars</button>
                <button class="nav-btn" data-screen="settings">Settings</button>
                <button class="nav-btn" data-screen="import-export">Import/Export</button>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main id="main-content">
            <!-- Screens will be dynamically shown/hidden -->
            <div id="screen-home" class="screen active"></div>
            <div id="screen-calendars" class="screen"></div>
            <div id="screen-editor" class="screen"></div>
            <div id="screen-settings" class="screen"></div>
            <div id="screen-import-export" class="screen"></div>
        </main>

        <!-- Toast Container -->
        <div id="toast-container"></div>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="hidden">
            <div class="spinner"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/db.js"></script>
    <script src="js/alarms.js"></script>
    <script src="js/file-handler.js"></script>
    <script src="js/app.js"></script>
    
    <!-- Service Worker Registration -->
    <script>
        let deferredPrompt;
        
        // Listen for beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install banner after a delay
            setTimeout(() => {
                if (deferredPrompt) {
                    showInstallBanner();
                }
            }, 5000);
        });
        
        function showInstallBanner() {
            const banner = document.createElement('div');
            banner.id = 'pwa-install-banner';
            banner.innerHTML = `
                <div class="pwa-install-content">
                    <span>Install RamadanReady for a better experience</span>
                    <div class="pwa-install-buttons">
                        <button id="install-btn">Install</button>
                        <button id="dismiss-btn">Not now</button>
                    </div>
                </div>
            `;
            banner.style.cssText = `
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: #1e3a5f;
                color: white;
                padding: 15px;
                z-index: 10000;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            `;
            
            const style = document.createElement('style');
            style.textContent = `
                .pwa-install-content {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    max-width: 800px;
                    margin: 0 auto;
                }
                .pwa-install-buttons button {
                    margin-left: 10px;
                    padding: 8px 16px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                }
                #install-btn {
                    background: #22c55e;
                    color: white;
                }
                #dismiss-btn {
                    background: transparent;
                    color: white;
                    border: 1px solid white;
                }
            `;
            document.head.appendChild(style);
            
            document.getElementById('install-btn').addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') {
                        console.log('App installed');
                    }
                    deferredPrompt = null;
                }
                banner.remove();
            });
            
            document.getElementById('dismiss-btn').addEventListener('click', () => {
                banner.remove();
            });
            
            document.body.appendChild(banner);
        }
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/RamadanReady/service-worker.js');
                    console.log('Service Worker registered:', registration.scope);
                    
                    // Check for updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                console.log('New service worker available');
                            }
                        });
                    });
                } catch (error) {
                    console.error('Service Worker registration failed:', error);
                }
            });
        }
        
        // Request notification permission on load
        if ('Notification' in window && Notification.permission === 'default') {
            // Don't auto-request, wait for user interaction
        }
    </script>
</body>
</html>